/* モーダルでIframeを表示
 * 	2010.01.28 noda@sola
 * prototype.js 必須
 * control.modal.js 必須
 * ページ上にaタグを設置。
 * 例) <a id="modal_link_one" href=""></a>
 * initializeにそのidを指定。
 * 設置例
 * 		clsModalIframe = new ModalIframe('modal_link_one');
 * 		タグ内イベントに
 * 		onClick="clsModalIframe.openModal(url)"
 * スタイルシート例
 *   	#modal_container {
 *      	padding:5px;
 *      	background-color:#fff;
 *      	border:1px solid #666;
 *      	overflow:auto;
 *      	font-family:"Lucida Grande",Verdana;
 *      	font-size:12px;
 *      	color:#333;
 *      	text-align:left;
 *   	}
 *   	#modal_overlay {
 *      	background-color:#000;
 *   	}
 */

ModalIframe = Class.create();
ModalIframe.prototype = {
	initialize: function(elename) {
		this.elename = elename;
		this.ele = $(elename);
		this.controlModal = null;
	},
	terminate: function() {
	},
	openModal: function(url ,w, h, name) {
		this.ele.href = url;
		this.controlModal = new Control.Modal(this.elename,{iframe: true,width: w,height: h,overlayCloseOnClick: false,iframeName: name});
		this.controlModal.open();
	},
	closeModal: function() {
		this.controlModal.close();
		this.ele.href = "";
		this.controlModal = null;
	}
}
//表示レイヤ変更
AddLayerModalIframe = Class.create();
AddLayerModalIframe.prototype = {
	initialize: function(elename) {
		this.elename = elename;
		this.ele = $(elename);
		this.controlModal = null;
	},
	terminate: function() {
	},
	openModal: function(url ,w, h, name) {
		this.ele.href = url;
		this.controlModal = new Control.Modal(this.elename,{iframe: true,width: w,height: h,overlayCloseOnClick: false,iframeName: name});
		this.controlModal.open();
	},
    //2012/08/14 XSL@SK No5 MODIFY START  
    getLayerSetting: function (aryLayerId, aryLayerDataType, aryLayerCodeSetUnid, tmptyMap) {
    //getLayerSetting: function(aryLayerId,aryLayerDataType,aryLayerCodeSetUnid) {
        mapLayerTree._requestInfo(aryLayerId, aryLayerDataType, aryLayerCodeSetUnid,tmptyMap);
        //mapLayerTree._requestInfo(aryLayerId,aryLayerDataType,aryLayerCodeSetUnid);
    //2012/08/14 XSL@SK No5 MODIFY END
		this.closeModal();
	},
	closeModal: function() {
		this.controlModal.close();
		this.ele.href = "";
		this.controlModal = null;
	}
}
//ユーザレイヤ変更
AddUserLayerModalIframe = Class.create();
AddUserLayerModalIframe.prototype = {
	initialize: function(elename) {
		this.elename = elename;
		this.ele = $(elename);
		this.controlModal = null;
	},
	terminate: function() {
	},
	openModal: function(url ,w, h, name) {
	    this.ele.href = url;
		this.controlModal = new Control.Modal(this.elename,{iframe: true,width: w,height: h,overlayCloseOnClick: false,iframeName: name,zIndex: 20000});
		this.controlModal.open();
	},
	getUserLayerSetting: function(aryLayerId,aryLayerDataType,aryLayerCodeSetUnid) {
		mapLayerTree.showUserLayer(aryLayerId,aryLayerDataType,aryLayerCodeSetUnid);
		this.closeModal();
	},
	addUserLayerSetting: function(aryLayerId,aryLayerDataType,aryLayerCodeSetUnid) {
		mapLayerTree.addUserLayer(aryLayerId,aryLayerDataType,aryLayerCodeSetUnid);
		//this.closeModal();
	},
    addFeatureAllAreaMap: function(extent){
        if (extent.left) {
            var points = [];
            points.push(new DPoint(parseFloat(extent.left), parseFloat(extent.bottom)));
            points.push(new DPoint(parseFloat(extent.right), parseFloat(extent.top)));
            moveAllAreaMap(points);
        }
    },
    setLegendReload: function() {
        var aryLayers = mapLayerTree.getMapThemeList('all');
        var aryCodeSetList = mapLayerTree.getMapCodeUnidList();
        mapLayerTree._requestInfo(aryLayers, "", aryCodeSetList);
    },
	//ADD START BY 143：20120202@QXC
    setLegendSingleReload: function(isUserLayer, newNode) {
        var aryLayers = "";
        var aryCodeSetList = "";
        if(!isUserLayer){
            aryLayers = mapLayerTree.getMapThemeList('all');
            aryCodeSetList = mapLayerTree.getMapCodeUnidList() + newNode;
            mapLayerTree._requestInfo(aryLayers, "", aryCodeSetList);
        }
        else{
            aryLayers = mapLayerTree.getMapUserList('all');
            aryCodeSetList = mapLayerTree.getMapUserCodeUnidList() + newNode;
            mapLayerTree._requestUserInfo(aryLayers, "" , aryCodeSetList);
        }
    },
    //ADD END BY 143：20120202@QXC
    setUMapSetting: function(mapID, umapID) {
		this.controlModal.close();
		this.ele.href = "";
		this.controlModal = null;

        var fullUrl = location.href;
        var url = fullUrl.split("?")[0];
        var param = fullUrl.split("?")[1];

        location.href = url + "?" + PARAM_USER_DATATYPE + "=" + umapID+ "&" + PARAM_DATATYPE + "=" + mapID;
    },
	closeModal: function() {
		this.controlModal.close();
		this.ele.href = "";
		this.controlModal = null;
		// ADD START BY 課題管理No156:20120221@XFR
		// モーダルウィンドウを閉じる時、地図を再描画する
        refreshMap();
		// ADD END BY 課題管理No156:20120221@XFR
	},
    //2012/6/8 YML@SK ADD 課題一覧:NO.50 START
    closeModalWithoutRefresh: function () {
        this.controlModal.close();
        this.ele.href = "";
        this.controlModal = null;
    }
    //2012/6/8 YML@SK ADD 課題一覧:NO.50 END
}
//データ編集（地図画面から）
AdminModalIframe = Class.create();
AdminModalIframe.prototype = {
	initialize: function(elename) {
		this.elename = elename;
		this.ele = $(elename);
		this.controlModal = null;
	},
	terminate: function() {
	},
	openModal: function(url ,w, h, name) {
		this.ele.href = url;
		this.controlModal = new Control.Modal(this.elename,{iframe: true,width: w,height: h,overlayCloseOnClick: false,iframeName: name});
		this.controlModal.open();
	},
    addLayerSetting: function(addLayerId,addLayerDataType,addLayerCodeSetUnid) {
        mapLayerTree.addLayer(addLayerId,addLayerDataType,addLayerCodeSetUnid);
    },
    addFeatureAllAreaMap: function(extent){
        if (extent.left) {
            var points = [];
            points.push(new DPoint(parseFloat(extent.left), parseFloat(extent.bottom)));
            points.push(new DPoint(parseFloat(extent.right), parseFloat(extent.top)));
            moveAllAreaMap(points);
        }
    },
	closeModal: function(centerXY) {
		this.controlModal.close();
		this.ele.href = "";
		this.controlModal = null;
        if (centerXY) {
		  refreshMap(new DPoint(parseFloat(centerXY.x), parseFloat(centerXY.y)));
        }else{
          refreshMap();
        }
	}
}
//データ編集（図形検索から）
AdminEditModalIframe = Class.create();
AdminEditModalIframe.prototype = {
	initialize: function(elename) {
		this.elename = elename;
		this.ele = $(elename);
		this.controlModal = null;
	},
	terminate: function() {
	},
	openModal: function(url ,w, h, name) {
		this.ele.href = url;
		this.controlModal = new Control.Modal(this.elename,{iframe: true,width: w,height: h,overlayCloseOnClick: false,iframeName: name});
		this.controlModal.open();
	},
	closeModal: function(centerXY) {
		this.controlModal.close();
		this.ele.href = "";
		this.controlModal = null;
	}
}

//データ編集（図形検索から）
loginModalIframe = Class.create();
loginModalIframe.prototype = {
	initialize: function(elename) {
		this.elename = elename;
		this.ele = $(elename);
		this.controlModal = null;
	    this.isOpen = false;
	},
	terminate: function() {
	},
	openModal: function(url ,w, h, name) {
		this.ele.href = url;
		this.controlModal = new Control.Modal(this.elename,{iframe: true,width: w,height: h,overlayCloseOnClick: false,iframeName: name});
		this.controlModal.open();
	    this.isOpen = true;
	},
    pageJump: function(url) {
        if (parent) {
            if (parent.opener) {
                parent.opener.document.location.href = url;
                if (window != parent.opener) {
                    window.close();
                    parent.close();
                    parent.opener.blur();
                    parent.opener.focus();
                }
            } else {
                parent.document.location.href = url;
                window.close();
            }
        } else {
            if (window.opener) {
                window.opener.document.location.href = url;
                if (window != window.opener) {
                    window.close();
                    window.opener.blur();
                    window.opener.focus();
                }
            } else {
                window.document.location.href = url;
            }
        }
    },
	closeModal: function() {
		this.controlModal.close();
		this.ele.href = "";
		this.controlModal = null;
	    this.isOpen = false;
	    if (map) {
	        var center = map.getCenter();
	        map.setCenter(center);
	    }
	}
}

//セッションチェック用Ajaxクラス
ajaxSessionManager = Class.create();
ajaxSessionManager.prototype = {
  initialize: function(url, args) {
	this._url = url;
    this._successAfter = function() {};
    if (typeof(args) != 'undefined' && typeof(args.successAfter) != 'undefined') {
        this._successAfter = args.successAfter;
    }
    this.__response = this._response.bindAsEventListener(this);
    this._ajaxRequest = new PSC.AjaxRequest();
    this._ajaxRequest.afterGetResponse = this.__response;

  }
  , executeAjax: function(params) {
    this._sendRequest(params);
  }
  , _sendRequest: function(params) {
    this._ajaxRequest.cancelRequest();
    this._ajaxRequest.sendRequest(this._url, params, 'post', true);
  }
  , _response: function(xmlHttp) {
    if (xmlHttp.readyState == 4) {
		if (xmlHttp.status == 200) {
            try{
              var decdata = decodeURI(xmlHttp.responseText);
              eval('var json='+decdata);
              if (json) {
                this._successAfter(json.result);
              };
            }catch(e){/*alert(e);*/}
		}
    };
  }
};

//ADD START BY 7: 20111231@QXC
//パスワードリセット
PasswordConfirmModalIframe = Class.create();
PasswordConfirmModalIframe.prototype = {
    initialize: function(elename) {
        this.elename = elename;
        this.ele = $(elename);
        this.controlModal = null;
    },
    terminate: function() {
    },
    openModal: function(url, w, h, name) {
        this.ele.href = url;
        this.controlModal = new Control.Modal(this.elename, { iframe: true, width: w, height: h, overlayCloseOnClick: false, iframeName: name });
        this.controlModal.open();
    },
    closeModal: function() {
        this.controlModal.close();
        this.ele.href = "";
        this.controlModal = null;
    }
}
//ADD END BY 7: 20111231@QXC

//ADD START BY 55:20120118@ZZ
//応用機能
AppliedModalIframe = Class.create();
AppliedModalIframe.prototype = {
    initialize: function (elename) {
        this.elename = elename;
        this.ele = $(elename);
        this.controlModal = null;
    },
    terminate: function () {
    },
    openModal: function (url, w, h, name) {
        this.ele.href = url;
        this.controlModal = new Control.Modal(this.elename, { iframe: true, width: w, height: h, overlayCloseOnClick: false, iframeName: name });
        this.controlModal.open();
    },
    addUserLayerSetting: function (aryLayerId, aryLayerDataType, aryLayerCodeSetUnid) {
        mapLayerTree.addUserLayer(aryLayerId, aryLayerDataType, aryLayerCodeSetUnid);
        //this.closeModal();
    },
    addFeatureAllAreaMap: function (extent) {
        if (extent.left) {
            var points = [];
            points.push(new DPoint(parseFloat(extent.left), parseFloat(extent.bottom)));
            points.push(new DPoint(parseFloat(extent.right), parseFloat(extent.top)));
            moveAllAreaMap(points);
        }
    },
    //ADD START BY 課題管理368:20120522@XFR
    //地図縮尺は制限を超えた場合、縮尺を再設定する
    //2012/6/8 XFR@SK UPDATE 指摘406 START
    //resetMapScale: function () {
    resetMapScale: function (uLayerMinScale) {
    //2012/6/8 XFR@SK UPDATE 指摘406 END
        var nowscale = map.scale.getValue();
        //2012/6/8 XFR@SK UPDATE 指摘406 START
        //if (nowscale > 320000) {
        //    changeScale(320000)
        //}
        if (nowscale > uLayerMinScale) {
            changeScale(uLayerMinScale)
        }
        //2012/6/8 XFR@SK UPDATE 指摘406 END
    },
    //ADD END BY 課題管理368:20120522@XFR
	/*2012/9/27 CXY@SK ADD 指摘75 START*/
	getScale: function(){
		return map.getScale();
	},
	getMapCenterX: function(){
		return map.getCenter().x;
	},
	getMapCenterY: function(){
		return map.getCenter().y;
	},
	/*2012/9/27 CXY@SK ADD 指摘75 END*/
    closeModal: function () {
        this.controlModal.close();
        this.ele.href = "";
        this.controlModal = null;
    }
}
//ADD END BY 55:20120118@ZZ
