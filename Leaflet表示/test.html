<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="imagetoolbar" content="no" />
    <title>geo:chishitsu_check EPSG:6673_L2500 image/png</title>
    <style type="text/css">
      body {
        font-family: sans-serif;
        font-weight: bold;
        font-size: 0.8em;
      }
      body {
        border: 0px;
        margin: 0px;
        padding: 0px;
      }
      #map {
        width: 85%;
        height: 85%;
        border: 0px;
        padding: 0px;
      }
      #info iframe {
        border: none;
      }
      .ol-scale-value {
        top: 24px;
        right: 8px;
        position: absolute;
      }
      .ol-zoom-value {
        top: 40px;
        right: 8px;
        position: absolute;
      }
    </style>
    <script src="../rest/web/openlayers3/ol.js"></script>
    <link
      rel="stylesheet"
      href="../rest/web/openlayers3/ol.css"
      type="text/css"
    />
    <script type="text/javascript">
      function init() {
        function ScaleControl(opt_options) {
          var options = opt_options || {};

          var element = document.createElement("div");
          element.setAttribute("id", "scale");
          element.className = "ol-scale-value";

          ol.control.Control.call(this, {
            element: element,
            target: options.target,
          });
        }
        ol.inherits(ScaleControl, ol.control.Control);
        ScaleControl.prototype.setMap = function (map) {
          map.on(
            "postrender",
            function () {
              var view = map.getView();
              var resolution = view.getResolution();
              var dpi = 90.71428571428572;
              var mpu = map.getView().getProjection().getMetersPerUnit();
              var scale = resolution * mpu * 39.37 * dpi;

              if (scale >= 9500 && scale <= 950000) {
                scale = Math.round(scale / 1000) + "K";
              } else if (scale >= 950000) {
                scale = Math.round(scale / 1000000) + "M";
              } else {
                scale = Math.round(scale);
              }
              document.getElementById("scale").innerHTML =
                "Scale = 1 : " + scale;
            },
            this
          );
          ol.control.Control.prototype.setMap.call(this, map);
        };

        function ZoomControl(opt_options) {
          var options = opt_options || {};

          var element = document.createElement("div");
          element.setAttribute("id", "zoom");
          element.className = "ol-zoom-value";

          ol.control.Control.call(this, {
            element: element,
            target: options.target,
          });
        }
        ol.inherits(ZoomControl, ol.control.Control);
        ZoomControl.prototype.setMap = function (map) {
          map.on(
            "moveend",
            function () {
              var view = map.getView();
              document.getElementById("zoom").innerHTML =
                "Zoom level = " + view.getZoom();
            },
            this
          );
          ol.control.Control.prototype.setMap.call(this, map);
        };

        var gridsetName = "EPSG:6673_L2500";
        var gridNames = [
          "EPSG:6673_L2500:0",
          "EPSG:6673_L2500:1",
          "EPSG:6673_L2500:2",
          "EPSG:6673_L2500:3",
          "EPSG:6673_L2500:4",
          "EPSG:6673_L2500:5",
        ];
        var baseUrl = "../service/wmts";
        var style = "";
        var format = "image/png";
        var infoFormat = "text/html";
        var layerName = "geo:chishitsu_check";
        var projection = new ol.proj.Projection({
          code: "EPSG:6673",
          units: "m",
          axisOrientation: "neu",
        });
        var resolutions = [
          27.999999999999996, 13.999999999999998, 6.999999999999999, 2.8, 1.4,
          0.7,
        ];
        baseParams = [
          "VERSION",
          "LAYER",
          "STYLE",
          "TILEMATRIX",
          "TILEMATRIXSET",
          "SERVICE",
          "FORMAT",
        ];

        params = {
          VERSION: "1.0.0",
          LAYER: layerName,
          STYLE: style,
          TILEMATRIX: gridNames,
          TILEMATRIXSET: gridsetName,
          SERVICE: "WMTS",
          FORMAT: format,
        };

        function constructSource() {
          var url = baseUrl + "?";
          for (var param in params) {
            if (baseParams.indexOf(param.toUpperCase()) < 0) {
              url = url + param + "=" + params[param] + "&";
            }
          }
          url = url.slice(0, -1);

          var source = new ol.source.WMTS({
            url: url,
            layer: params["LAYER"],
            matrixSet: params["TILEMATRIXSET"],
            format: params["FORMAT"],
            projection: projection,
            tileGrid: new ol.tilegrid.WMTS({
              tileSize: [256, 256],
              extent: [
                -110992.00295450131, -207439.91742665006, 111215.99704549866,
                -28239.917426650092,
              ],
              origin: [-110992.00295450131, -28239.917426650092],
              resolutions: resolutions,
              matrixIds: params["TILEMATRIX"],
            }),
            style: params["STYLE"],
            wrapX: true,
          });
          return source;
        }

        var layer = new ol.layer.Tile({
          source: constructSource(),
        });

        var view = new ol.View({
          center: [0, 0],
          zoom: 2,
          resolutions: resolutions,
          projection: projection,
          extent: [
            -110992.00295450131, -207439.91742665006, 111215.99704549866,
            -28239.917426650092,
          ],
        });

        var map = new ol.Map({
          controls: ol.control
            .defaults({ attribution: false })
            .extend([
              new ol.control.MousePosition(),
              new ScaleControl(),
              new ZoomControl(),
            ]),
          layers: [layer],
          target: "map",
          view: view,
        });
        map
          .getView()
          .fit([30000.0, -160000.0, 70000.0, -120000.0], map.getSize());

        window.setParam = function (name, value) {
          if (name == "STYLES") {
            name = "STYLE";
          }
          params[name] = value;
          layer.setSource(constructSource());
          map.updateSize();
        };

        map.on("singleclick", function (evt) {
          document.getElementById("info").innerHTML = "";

          var source = layer.getSource();
          var resolution = view.getResolution();
          var tilegrid = source.getTileGrid();
          var tileResolutions = tilegrid.getResolutions();
          var zoomIdx,
            diff = Infinity;

          for (var i = 0; i < tileResolutions.length; i++) {
            var tileResolution = tileResolutions[i];
            var diffP = Math.abs(resolution - tileResolution);
            if (diffP < diff) {
              diff = diffP;
              zoomIdx = i;
            }
            if (tileResolution < resolution) {
              break;
            }
          }
          var tileSize = tilegrid.getTileSize(zoomIdx);
          var tileOrigin = tilegrid.getOrigin(zoomIdx);

          var fx =
            (evt.coordinate[0] - tileOrigin[0]) / (resolution * tileSize[0]);
          var fy =
            (tileOrigin[1] - evt.coordinate[1]) / (resolution * tileSize[1]);
          var tileCol = Math.floor(fx);
          var tileRow = Math.floor(fy);
          var tileI = Math.floor((fx - tileCol) * tileSize[0]);
          var tileJ = Math.floor((fy - tileRow) * tileSize[1]);
          var matrixIds = tilegrid.getMatrixIds()[zoomIdx];
          var matrixSet = source.getMatrixSet();

          var url = baseUrl + "?";
          for (var param in params) {
            if (param.toUpperCase() == "TILEMATRIX") {
              url = url + "TILEMATRIX=" + matrixIds + "&";
            } else {
              url = url + param + "=" + params[param] + "&";
            }
          }

          url =
            url +
            "SERVICE=WMTS&REQUEST=GetFeatureInfo" +
            "&INFOFORMAT=" +
            infoFormat +
            "&TileCol=" +
            tileCol +
            "&TileRow=" +
            tileRow +
            "&I=" +
            tileI +
            "&J=" +
            tileJ;

          if (url) {
            document.getElementById("info").innerHTML =
              "Loading... please wait...";
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function () {
              if (xmlhttp.readyState == XMLHttpRequest.DONE) {
                if (xmlhttp.status == 200) {
                  document.getElementById("info").innerHTML =
                    xmlhttp.responseText;
                } else {
                  document.getElementById("info").innerHTML = "";
                }
              }
            };
            xmlhttp.open("GET", url, true);
            xmlhttp.send();
          }
        });
      }
    </script>
  </head>
  <body onload="init()">
    <div id="params"></div>
    <div id="map"></div>
    <div id="info"></div>
  </body>
</html>
