<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>leaflet-boilerplate</title>
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-hash@0.2.1/leaflet-hash.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
    <script src="leaflet.tilelayer.wmts.min.js"></script>
    <script src="proj4.js"></script>
    <script src="proj4leaflet.js"></script>
    <style>
      .leaflet-control-container::after {
        content: url(https://maps.gsi.go.jp/image/map/crosshairs.png);
        z-index: 1000;
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    </style>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <a href="osm.html">OpenStreetMapへ移動</a>
    <a href="cesium.html">Cesiumへ移動</a>
    <div id="map" style="width: 800px; height: 400px"></div>
    <script>
      axios
        .get("https://jsonplaceholder.typicode.com/users")
        .then((response) => console.log(response.data))
        .catch(function (error) {
          console.log(error);
        });
      var url_default = "http://localhost:8888/geoserver/wfs";
      var defaultParameters = {
        service: "WFS",
        version: "1.0.0",
        request: "GetFeature",
        typeName: "test:照会_回答依頼書",
        outputFormat: "application/json",
      };
      var parameters = L.Util.extend(defaultParameters);
      var url = url_default + L.Util.getParamString(parameters);
      axios
        .get(url)
        .then((response) => console.log(response.data))
        .catch(function (error) {
          console.log(error);
        });

      //背景地図
      let json = [
        {
          name: "淡色地図",
          url: "https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png",
          options: {
            attribution:
              "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
          },
        },
        {
          name: "標準地図",
          url: "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
          options: {
            attribution:
              "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
          },
        },
        {
          name: "色別標高図",
          url: "https://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png",
          options: {
            attribution:
              "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
          },
        },
        {
          name: "写真",
          url: "https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg",
          options: {
            attribution:
              "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
          },
        },
        {
          name: "OpenStreetMap",
          url: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
          options: {
            attribution:
              "&copy; <a href='http://osm.org/copyright'>OpenStreetMap</a> contributors",
          },
        },
      ];
      let baseLayers = {};
      for (const i in json) {
        const name = json[i].name;
        const url = json[i].url;
        const options = json[i].options;
        console.log(name, url, options);
        baseLayers[name] = L.tileLayer(url, options);
      }
      console.log(baseLayers);

      let overlayLayers = {};
      //zxyを表示するタイルレイヤのクラス
      const GridLayerClass = L.GridLayer.extend({
        createTile: function (coords) {
          //div要素でタイルを作成
          var tileDiv = L.DomUtil.create("div", "");
          tileDiv.setAttribute("style", "border: solid 1px");
          //タイル要素の中にzxyを表示するdiv要素を作成
          var coordsDiv = L.DomUtil.create("div", "", tileDiv);
          coordsDiv.setAttribute(
            "style",
            "position:absolute;background-color:white;padding:5px;border: solid 1px;left:10px;top:10px;font-size:15px"
          );
          coordsDiv.innerHTML =
            "z / x / y = " + coords.z + " / " + coords.x + " / " + coords.y;
          return tileDiv;
        },
      });
      overlayLayers["XYZ Grid"] = new GridLayerClass();
      overlayLayers["包蔵地"] = L.tileLayer.wms(
        "http://localhost:8888/geoserver/wms",
        {
          layers: "test:包蔵地",
          format: "image/png",
          transparent: true,
          version: "1.3.0",
          attribution: "myattribution",
        }
      );
      overlayLayers["照会_回答依頼書"] = L.tileLayer.wms(
        "http://localhost:8888/geoserver/wms",
        {
          layers: "test:照会_回答依頼書",
          format: "image/png",
          transparent: true,
          version: "1.3.0",
          attribution: "myattribution",
        }
      );
      overlayLayers["地形図"] = L.tileLayer.wms(
        "http://lg2201001:8080/geoserver/wms",
        {
          layers: "chikei:地形図2500",
          format: "image/png",
          transparent: true,
          version: "1.3.0",
          attribution: "myattribution",
        }
      );
      overlayLayers["行政区域界"] = L.tileLayer.wms(
        "http://lg2201001:8080/geoserver/wms",
        {
          layers: "chikei:行政区域界",
          format: "image/png",
          transparent: true,
          version: "1.3.0",
          attribution: "myattribution",
        }
      );
      overlayLayers["包蔵地_LG2201001"] = L.tileLayer.wms(
        "http://lg2201001:8080/geoserver/wms",
        {
          layers: "bunkazai:包蔵地",
          format: "image/png",
          transparent: true,
          version: "1.3.0",
          attribution: "myattribution",
        }
      );
      overlayLayers["照会_回答依頼書_LG2201001"] = L.tileLayer.wms(
        "http://lg2201001:8080/geoserver/wms",
        {
          layers: "bunkazai:照会_回答依頼書",
          format: "image/png",
          transparent: true,
          version: "1.3.0",
          attribution: "myattribution",
        }
      );
      overlayLayers["地形図_LG2201001"] = L.tileLayer.wms(
        "http://lg2201001:8080/geoserver/wms",
        {
          layers: "chikei:地形図2500",
          format: "image/png",
          transparent: true,
          version: "1.3.0",
          attribution: "myattribution",
        }
      );
      overlayLayers["行政区域界_LG2201001"] = L.tileLayer.wms(
        "http://lg2201001:8080/geoserver/wms",
        {
          layers: "chikei:行政区域界",
          format: "image/png",
          transparent: true,
          version: "1.3.0",
          attribution: "myattribution",
        }
      );

      //WMTS 確認
      var gridsetName = "EPSG:6673_L2500";
      var gridsize = 6;
      var gridNames = [
        "EPSG:6673_L2500:0",
        "EPSG:6673_L2500:1",
        "EPSG:6673_L2500:2",
        "EPSG:6673_L2500:3",
        "EPSG:6673_L2500:4",
        "EPSG:6673_L2500:5",
      ];
      var baseUrl = "http://localhost:8888/geoserver/gwc/service/wmts"; //"../service/wmts";
      baseUrl = "http://lg2201001:8080/geoserver/gwc/service/wmts";
      var style = "";
      var format = "image/png";
      var infoFormat = "text/html";
      var layerName = "geological:地質図"; //"geo:chishitsu_check";

      var defExtent = [
        -110992.00295450131, -207439.91742665006, 111215.99704549866,
        -28239.917426650092,
      ];
      var resolutions = [
        27.999999999999996, 13.999999999999998, 6.999999999999999, 2.8, 1.4,
        0.7,
      ];
      baseParams = [
        "VERSION",
        "LAYER",
        "STYLE",
        "TILEMATRIX",
        "TILEMATRIXSET",
        "SERVICE",
        "FORMAT",
      ];

      params = {
        VERSION: "1.0.0",
        LAYER: layerName,
        STYLE: style,
        TILEMATRIX: gridNames,
        TILEMATRIXSET: gridsetName,
        SERVICE: "WMTS",
        FORMAT: format,
      };

      proj4.defs(
        "EPSG:6673",
        "+proj=tmerc +lat_0=36 +lon_0=134.3333333333333 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs"
      );
      var crs6673 = new L.Proj.CRS(
        "EPSG:6673",
        "+proj=tmerc +lat_0=36 +lon_0=134.3333333333333 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs",
        {
          resolutions: resolutions,
          origin: [defExtent[0], defExtent[3]],
        }
      );

      function constructSource() {
        var url = baseUrl + "?";
        for (var param in params) {
          if (baseParams.indexOf(param.toUpperCase()) < 0) {
            url = url + param + "=" + params[param] + "&";
          }
        }
        url = url.slice(0, -1);

        var source = new L.TileLayer.WMTS({
          url: url,
          layer: params["LAYER"],
          matrixSet: params["TILEMATRIXSET"],
          format: params["FORMAT"],
          crs: projection,
          tileGrid: new ol.tilegrid.WMTS({
            tileSize: [256, 256],
            extent: defExtent,
            origin: ol.extent.getTopLeft(defExtent),
            resolutions: resolutions,
            matrixIds: params["TILEMATRIX"],
          }),
          style: params["STYLE"],
          wrapX: true,
        });
        return source;
      }

      /** Url to WMTS server */
      const wmtsurl = "http://lg2201001:8080/geoserver/gwc/service/wmts"; //"http://localhost:8888/geoserver/gwc/service/wmts/";

      /** WMTS tile options */
      const wmtsOptions = {
        layer: layerName,
        style: "",
        TileMatrixSet: gridsetName,
        format: "image/png",
        opacity: 0.7,
        TileMatrix: "EPSG:6673_L2500:0",
        TileCol: 23,
        TileRow: 13,
      };
      overlayLayers["地質図_WMTS"] = new L.TileLayer.WMTS(wmtsurl, wmtsOptions);
      /*
        //WFS設定
        let wfsUrl = "http://localhost:8888/geoserver/wfs";
        var defaultParameters = {
          service: "WFS",
          version: "1.0.0",
          request: "GetFeature",
          typeName: "test:照会_回答依頼書",
          outputFormat: "application/json",
        };
        var parameters = L.Util.extend(defaultParameters);
        var url = wfsUrl + L.Util.getParamString(parameters);
        axios
          .get(url)
          .then((response) => {
            console.log(response.data);
            // Create layer and add it to the map
            var layers = L.geoJSON(response.data, {
              onEachFeature: function (feature, layer) {
                layer.bindPopup(feature.properties);
              },
            });
            console.log(layers);
            overlayLayers["test"] = layers;
            //layers.addTo(map);
          })
          .catch(function (error) {
            console.log(error);
          });
        console.log(overlayLayers);
        */
      const map = L.map(
        "map",
        {
          center: [34.725, 134.8683], // Moscow
          //center: [0, 0],
          zoom: 13,
          //maxZoom: resolutions.length,
          crs: crs6673,
          minZoom: 0,
          maxZoom: 5,
        }
        //L.Hash.parseHash(location.hash),
      );

      //レイヤの設定
      L.control
        .layers(baseLayers, overlayLayers, {
          collapsed: false,
        })
        .addTo(map);

      map.zoomControl.setPosition("bottomright");

      L.control
        .scale({
          imperial: false,
          metric: true,
        })
        .addTo(map);

      L.hash(map);

      L.marker(map.getCenter()).addTo(map);
    </script>
  </body>
</html>
